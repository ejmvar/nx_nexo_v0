# ============================================================================
# NEXO CRM - Development Environment Configuration
# ============================================================================
# Testing Philosophy: Every step must be testable and simple
# Run 'mise tasks' to see all available tasks
# Run 'mise run test:all' to run all tests
# Run 'mise run dev' to start development environment
# ============================================================================

[vars]
PROJECT_NAME = "nexo-prj"
DOCKER_COMPOSE_FILE = "docker/docker-compose.yml"

# /myproject/mise.toml
experimental_monorepo_root = true

[env]
MISE_EXPERIMENTAL=0
_.file = ".GITHUB_EJMV_OWN.env"
PROJECT_NAME = "nexo-prj"

[tools]
node = "latest"
npm = "latest"
pnpm = "latest"
bun = "latest"

# ============================================================================
# BASIC SETUP TASKS
# ============================================================================

[tasks.100-000-001-nx-pnpm-install]
description = "Installs/Updates Nx CLI using PNPM"
raw = true
run = ". ~/.bashrc && pnpm setup && . ~/.bashrc && pnpm install -g nx"

[tasks.100-000-002-nx-CREATE-pnpm-project-here]
description = "Initialize NX in this EXISTING project"
raw = true
run = "npx create-nx-workspace@latest {{vars.PROJECT_NAME}} --package-manager=pnpm"

# ===============================
# ROBUST STARTUP & SHUTDOWN - ALL ENVIRONMENTS
# ===============================

[tasks.startup]
description = "üöÄ Robust startup for TEST/DEV/QA/PROD environments"
run = "bash scripts/startup.sh start"

[tasks.startup-test]
description = "üß™ Start test environment"
run = "NEXO_ENV=test bash scripts/startup.sh start"

[tasks.startup-dev]
description = "üíª Start development environment"
run = "NEXO_ENV=dev bash scripts/startup.sh start"

[tasks.startup-qa]
description = "üîç Start QA/staging environment"
run = "NEXO_ENV=qa bash scripts/startup.sh start"

[tasks.shutdown]
description = "üõë Graceful shutdown (preserve database)"
run = "bash scripts/shutdown.sh stop"

[tasks.shutdown-force]
description = "‚ö†Ô∏è  Force shutdown (ignore errors)"
run = "bash scripts/shutdown.sh force"

[tasks.shutdown-clean]
description = "üßπ Complete shutdown (including database)"
run = "bash scripts/shutdown.sh clean"

[tasks.restart]
description = "üîÑ Restart all services"
run = "mise run shutdown && sleep 2 && mise run startup"

[tasks.restart-clean]
description = "üîÑ Clean restart (full reset)"
run = "mise run shutdown-clean && sleep 5 && mise run startup"

[tasks.status]
description = "üìä Show system status"
run = "bash scripts/startup.sh status"

[tasks.health]
description = "üè• Check all services health"
run = "bash scripts/health-check.sh"

[tasks.logs-startup]
description = "üìã View startup logs"
run = "tail -100 tmp/logs/startup-*.log | tail -100"

[tasks.logs-shutdown]
description = "üìã View shutdown logs"  
run = "tail -100 tmp/logs/shutdown-*.log | tail -100"

# ===============================
# TESTING TASKS - DEVELOPMENT CYCLE
# ===============================

[tasks.test-setup]
description = "Setup testing environment and verify all tools"
run = "echo 'üîß Setting up testing environment...' && mise doctor && echo '‚úÖ MISE environment verified' && cd nexo-prj && pnpm install && echo '‚úÖ Dependencies installed'"

[tasks.test-approve-builds]
description = "Approve pnpm build scripts (one-time setup)"
run = "cd nexo-prj && pnpm approve-builds"
depends = ["100-000-001-nx-pnpm-install"]

[tasks.test-install]
description = "Install all project dependencies"
run = "cd nexo-prj && pnpm install"
depends = ["test-approve-builds"]

[tasks.test-lint]
description = "Run ESLint on all projects"
run = "cd nexo-prj && npx nx run-many --target=lint --all"
depends = ["test-install"]

[tasks.test-typecheck]
description = "Run TypeScript type checking on all projects"
run = "cd nexo-prj && npx nx run-many --target=typecheck --all"
depends = ["test-install"]

[tasks.test-unit]
description = "Run unit tests for all projects"
run = "cd nexo-prj && npx nx run-many --target=test --all"
depends = ["test-install"]

[tasks.test-unit-watch]
description = "Run unit tests in watch mode"
run = "cd nexo-prj && npx nx run-many --target=test --all --watch"
depends = ["test-install"]

[tasks.test-unit-coverage]
description = "Run unit tests with coverage report"
run = "cd nexo-prj && npx nx run-many --target=test --all --coverage"
depends = ["test-install"]

[tasks.test-cleanup-services]
description = "Kill all running test services (auth, crm, gateway, frontend)"
run = "bash scripts/shutdown.sh stop"

[tasks.test-e2e]
description = "Run verified E2E tests (CRM API endpoints only)"
run = "cd nexo-prj && pnpm exec playwright test crm-api-endpoints.spec.ts --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-e2e-all]
description = "Run ALL E2E tests (includes incomplete/experimental tests)"
run = "cd nexo-prj && pnpm exec playwright test --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-e2e-ui]
description = "Run E2E tests with UI mode (Playwright)"
run = "cd nexo-prj && pnpm exec playwright test --ui"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-e2e-headed]
description = "Run E2E tests in headed mode (visible browser for user verification)"
run = "cd nexo-prj && pnpm exec playwright test crm-api-endpoints.spec.ts --headed --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-file-operations]
description = "Run file operations E2E tests (API-level)"
run = "cd nexo-prj && pnpm exec playwright test --project=file-operations --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-file-upload-ui]
description = "Run file upload UI E2E tests (browser-based)"
run = "cd nexo-prj && pnpm exec playwright test --project=file-upload-ui --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-file-upload-ui-headed]
description = "Run file upload UI tests in headed mode (visible browser)"
run = "cd nexo-prj && pnpm exec playwright test --project=file-upload-ui --headed --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-files-all]
description = "Run all file-related tests (API + UI)"
run = "cd nexo-prj && pnpm exec playwright test file-operations.spec.ts file-upload-ui.spec.ts --reporter=list"
depends = ["test-install", "test-cleanup-services"]

[tasks.test-build]
description = "Build all projects and verify production readiness"
run = "cd nexo-prj && npx nx run-many --target=build --all"
depends = ["test-install"]

[tasks.test-build-deps]
description = "Build all project dependencies"
run = "cd nexo-prj && npx nx run-many --target=build-deps --all"
depends = ["test-install"]

[tasks.test-all]
description = "Run complete test suite: lint ‚Üí typecheck ‚Üí unit ‚Üí e2e ‚Üí build"
run = "mise run test-lint && mise run test-typecheck && mise run test-unit && mise run test-e2e && mise run test-build"
depends = ["test-setup"]

[tasks.test-ci]
description = "Run CI pipeline simulation (all tests + coverage)"
run = "mise run test-lint && mise run test-typecheck && mise run test-unit-coverage && mise run test-e2e && mise run test-build"
depends = ["test-setup"]

[tasks.test-dev]
description = "Start development server with hot reload"
run = "cd nexo-prj && npx nx serve nexo-prj"
depends = ["test-install"]

[tasks.test-dev-all]
description = "Start core development servers (auth, crm, frontend)"
# # DON'T REMOVE : # run = "cd nexo-prj && npx nx run-many --target=serve --all --parallel"

run = """
run = "NEXO_ENV=dev bash scripts/startup.sh startasks.test-clean]
description = "Clean all build artifacts and caches"
run = "cd nexo-prj && npx nx reset && rm -rf .next node_modules/.cache"

[tasks.test-reset]
description = "Full reset: clean + reinstall + test"
run = "mise run test-clean && mise run test-install && mise run test-all"

# ===============================
# QUICK DEVELOPMENT TASKS
# ===============================

[tasks.check]
description = "Quick health check (lint + typecheck + unit)"
run = "mise run test-lint && mise run test-typecheck && mise run test-unit"

[tasks.ci]
description = "Simulate CI pipeline"
run = "mise run test-ci"

# ===============================
# COMPONENT TESTING TASKS
# ===============================

[tasks.test-components]
description = "Test shared UI components"
run = "cd nexo-prj && npx nx test shared-ui --coverage"
depends = ["test-install"]

[tasks.test-app]
description = "Test main application"
run = "cd nexo-prj && npx nx test nexo-prj --coverage"
depends = ["test-install"]

# Removed: nexo-prj-e2e project doesn't exist
# E2E tests are now in root playwright.config.ts
# Use: mise run test-e2e, test-e2e-headed, test-e2e-ui, or test-e2e-all

# ===============================
# DEBUGGING TASKS
# ===============================

[tasks.test-debug-unit]
description = "Debug unit tests with inspector"
run = "cd nexo-prj && npx nx test nexo-prj --inspect --inspect-brk"

[tasks.test-debug-e2e]
description = "Debug E2E tests with headed browser"
run = "cd nexo-prj && npx nx e2e nexo-prj-e2e --headed --debug"

# ===============================
# PERFORMANCE TESTING
# ===============================

[tasks.test-perf-build]
description = "Test build performance"
run = "cd nexo-prj && time npx nx build nexo-prj"

[tasks.test-perf-test]
description = "Test test execution performance"
run = "cd nexo-prj && time npx nx run-many --target=test --all"

# ============================================================================
# DOCKER MULTI-ENVIRONMENT TASKS
# ============================================================================
# Port Strategy:
# - Local NX Dev:  3xxx ports (3000, 3001, 3003, 3002)
# - Docker DEV:    4xxx ports (4000, 4001, 4003, 4002)
# - Docker TEST:   5xxx ports (5000, 5001, 5003, 5002)
# - Docker QA:     6xxx ports (6000, 6001, 6003, 6002)
# - Docker PROD:   7xxx ports (7000, 7001, 7003, 7002)
# ============================================================================

# LEGACY DOCKER TASKS (Original docker-compose.yml)
[tasks."docker:validate"]
description = "Validate docker-compose.yml syntax"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} config > /dev/null && echo '‚úì Docker Compose configuration is valid'"

[tasks."docker:build"]
description = "Build all Docker images"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} build"

[tasks."docker:up"]
description = "Start all Docker services"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} up -d"

[tasks."docker:down"]
description = "Stop all Docker services"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} down"

[tasks."docker:logs"]
description = "View Docker logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f"

[tasks."docker:ps"]
description = "List running Docker containers"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} ps"

[tasks."docker:clean"]
description = "Clean Docker resources (containers, volumes, networks)"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} down -v --remove-orphans"

[tasks."docker:restart"]
description = "Restart Docker services"
run = "mise run docker:down && mise run docker:up"

# ============================================================================
# DOCKER DEV ENVIRONMENT (Port 4xxx)
# ============================================================================

[tasks."docker-dev:up"]
description = "üîµ Start Docker DEV environment (port 4xxx)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.dev.yml up -d"

[tasks."docker-dev:down"]
description = "üîµ Stop Docker DEV environment"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.dev.yml down"

[tasks."docker-dev:logs"]
description = "üîµ View Docker DEV logs"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.dev.yml logs -f"

[tasks."docker-dev:ps"]
description = "üîµ List Docker DEV containers"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.dev.yml ps"

[tasks."docker-dev:restart"]
description = "üîµ Restart Docker DEV environment"
run = "mise run docker-dev:down && sleep 2 && mise run docker-dev:up"

[tasks."docker-dev:clean"]
description = "üîµ Clean Docker DEV (remove volumes)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.dev.yml down -v --remove-orphans"

[tasks."docker-dev:build"]
description = "üîµ Build Docker DEV images"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.dev.yml build"

[tasks."docker-dev:health"]
description = "üîµ Check Docker DEV health"
run = "curl -sf http://localhost:4001/health && curl -sf http://localhost:4003/health && curl -sf http://localhost:4000 && echo 'DEV environment healthy'"

# ============================================================================
# DOCKER TEST ENVIRONMENT (Port 5xxx)
# ============================================================================

[tasks."docker-test:up"]
description = "üü¢ Start Docker TEST environment (port 5xxx)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.test.yml up -d"

[tasks."docker-test:down"]
description = "üü¢ Stop Docker TEST environment"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.test.yml down"

[tasks."docker-test:logs"]
description = "üü¢ View Docker TEST logs"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.test.yml logs -f"

[tasks."docker-test:ps"]
description = "üü¢ List Docker TEST containers"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.test.yml ps"

[tasks."docker-test:restart"]
description = "üü¢ Restart Docker TEST environment"
run = "mise run docker-test:down && sleep 2 && mise run docker-test:up"

[tasks."docker-test:clean"]
description = "üü¢ Clean Docker TEST (remove volumes)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.test.yml down -v --remove-orphans"

[tasks."docker-test:build"]
description = "üü¢ Build Docker TEST images"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.test.yml build"

[tasks."docker-test:health"]
description = "üü¢ Check Docker TEST health"
run = "curl -sf http://localhost:5001/health && curl -sf http://localhost:5003/health && curl -sf http://localhost:5000 && echo 'TEST environment healthy'"

# ============================================================================
# DOCKER QA ENVIRONMENT (Port 6xxx)
# ============================================================================

[tasks."docker-qa:up"]
description = "üü° Start Docker QA environment (port 6xxx)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.qa.yml up -d"

[tasks."docker-qa:down"]
description = "üü° Stop Docker QA environment"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.qa.yml down"

[tasks."docker-qa:logs"]
description = "üü° View Docker QA logs"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.qa.yml logs -f"

[tasks."docker-qa:ps"]
description = "üü° List Docker QA containers"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.qa.yml ps"

[tasks."docker-qa:restart"]
description = "üü° Restart Docker QA environment"
run = "mise run docker-qa:down && sleep 2 && mise run docker-qa:up"

[tasks."docker-qa:clean"]
description = "üü° Clean Docker QA (remove volumes)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.qa.yml down -v --remove-orphans"

[tasks."docker-qa:build"]
description = "üü° Build Docker QA images"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.qa.yml build"

[tasks."docker-qa:health"]
description = "üü° Check Docker QA health"
run = "curl -sf http://localhost:6001/health && curl -sf http://localhost:6003/health && curl -sf http://localhost:6000 && echo 'QA environment healthy'"

# ============================================================================
# DOCKER PROD ENVIRONMENT (Port 7xxx)
# ============================================================================

[tasks."docker-prod:up"]
description = "üî¥ Start Docker PROD environment (port 7xxx)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.prod.yml up -d"

[tasks."docker-prod:down"]
description = "üî¥ Stop Docker PROD environment"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.prod.yml down"

[tasks."docker-prod:logs"]
description = "üî¥ View Docker PROD logs"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.prod.yml logs -f"

[tasks."docker-prod:ps"]
description = "üî¥ List Docker PROD containers"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.prod.yml ps"

[tasks."docker-prod:restart"]
description = "üî¥ Restart Docker PROD environment"
run = "mise run docker-prod:down && sleep 2 && mise run docker-prod:up"

[tasks."docker-prod:clean"]
description = "üî¥ Clean Docker PROD (remove volumes)"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.prod.yml down -v --remove-orphans"

[tasks."docker-prod:build"]
description = "üî¥ Build Docker PROD images"
run = "unset DOCKER_HOST && docker compose -f docker/docker-compose.prod.yml build"

[tasks."docker-prod:health"]
description = "üî¥ Check Docker PROD health"
run = "curl -sf http://localhost:7001/health && curl -sf http://localhost:7003/health && curl -sf http://localhost:7000 && echo 'PROD environment healthy'"

# ========================================================================
# MULTI-ENVIRONMENT MANAGEMENT
# ============================================================================

[tasks."docker-all:up"]
description = "üåê Start ALL Docker environments (DEV+TEST+QA+PROD)"
run = "mise run docker-dev:up && mise run docker-test:up && mise run docker-qa:up && mise run docker-prod:up"

[tasks."docker-all:down"]
description = "üåê Stop ALL Docker environments"
run = "mise run docker-dev:down && mise run docker-test:down && mise run docker-qa:down && mise run docker-prod:down"

[tasks."docker-all:clean"]
description = "üåê Clean ALL Docker environments"
run = "mise run docker-dev:clean && mise run docker-test:clean && mise run docker-qa:clean && mise run docker-prod:clean"

[tasks."docker-all:ps"]
description = "üåê List ALL Docker containers"
run = "echo '=== DEV ===' && mise run docker-dev:ps && echo '=== TEST ===' && mise run docker-test:ps && echo '=== QA ===' && mise run docker-qa:ps && echo '=== PROD ===' && mise run docker-prod:ps"

[tasks."docker-all:health"]
description = "üåê Check ALL Docker environments health"
run = "echo '=== DEV (4xxx) ===' && mise run docker-dev:health && echo '=== TEST (5xxx) ===' && mise run docker-test:health && echo '=== QA (6xxx) ===' && mise run docker-qa:health && echo '=== PROD (7xxx) ===' && mise run docker-prod:health"

[tasks."test:docker:health"]
description = "Test Docker services health"
run = "bash scripts/test-docker-health.sh"

[tasks."test:docker:connectivity"]
description = "Test connectivity between Docker services"
run = "bash scripts/test-docker-connectivity.sh"

[tasks."test:backend:health"]
description = "Test backend API health and endpoints"
run = "bash scripts/test-backend-health.sh"

[tasks."test:backend:database"]
description = "Test backend database connectivity"
run = "bash scripts/test-backend-database.sh"

# ============================================================================
# KUBERNETES TESTING TASKS
# ============================================================================

[tasks."k8s:validate"]
description = "Validate Kubernetes manifests"
run = "bash scripts/validate-k8s.sh"

[tasks."k8s:dry-run"]
description = "Dry run K8s deployment"
run = "kubectl apply -f k8s/ --dry-run=client"

[tasks."k8s:deploy"]
description = "Deploy to Kubernetes"
run = "bash scripts/deploy.sh"

# ============================================================================
# HELM TASKS
# ============================================================================

[tasks."helm:lint"]
description = "Lint Helm chart"
run = "helm lint helm/nexo-crm"

[tasks."helm:template"]
description = "Render Helm templates"
run = "helm template nexo-crm helm/nexo-crm"

[tasks."helm:template:dev"]
description = "Render Helm templates for development"
run = "helm template nexo-crm helm/nexo-crm -f helm/nexo-crm/values-dev.yaml"

[tasks."helm:template:staging"]
description = "Render Helm templates for staging"
run = "helm template nexo-crm helm/nexo-crm -f helm/nexo-crm/values-staging.yaml"

[tasks."helm:template:prod"]
description = "Render Helm templates for production"
run = "helm template nexo-crm helm/nexo-crm -f helm/nexo-crm/values-prod.yaml"

[tasks."helm:install:dev"]
description = "Install Helm chart (development)"
run = "helm install nexo-crm helm/nexo-crm -f helm/nexo-crm/values-dev.yaml"

[tasks."helm:install:staging"]
description = "Install Helm chart (staging)"
run = "helm install nexo-crm helm/nexo-crm -f helm/nexo-crm/values-staging.yaml"

[tasks."helm:install:prod"]
description = "Install Helm chart (production)"
run = "helm install nexo-crm helm/nexo-crm -f helm/nexo-crm/values-prod.yaml"

[tasks."helm:upgrade:dev"]
description = "Upgrade Helm release (development)"
run = "helm upgrade nexo-crm helm/nexo-crm -f helm/nexo-crm/values-dev.yaml"

[tasks."helm:upgrade:staging"]
description = "Upgrade Helm release (staging)"
run = "helm upgrade nexo-crm helm/nexo-crm -f helm/nexo-crm/values-staging.yaml"

[tasks."helm:upgrade:prod"]
description = "Upgrade Helm release (production)"
run = "helm upgrade nexo-crm helm/nexo-crm -f helm/nexo-crm/values-prod.yaml"

[tasks."helm:uninstall"]
description = "Uninstall Helm release"
run = "helm uninstall nexo-crm"

[tasks."helm:list"]
description = "List Helm releases"
run = "helm list"

[tasks."helm:status"]
description = "Show Helm release status"
run = "helm status nexo-crm"

[tasks."test:helm:validate"]
description = "Validate Helm chart configuration and templates"
run = "bash scripts/test-helm-validate.sh"

# ============================================================================
# APPLICATION TESTING TASKS
# ============================================================================

[tasks."test:nx:install"]
description = "Test Nx installation"
run = "cd {{vars.PROJECT_NAME}} && nx --version && echo '‚úì Nx is installed'"

[tasks."test:pnpm:install"]
description = "Test pnpm dependencies"
run = "cd {{vars.PROJECT_NAME}} && pnpm install && echo '‚úì Dependencies installed'"

[tasks."test:nx:build:all"]
description = "Test build all Nx projects"
run = "cd {{vars.PROJECT_NAME}} && nx run-many --target=build --all"

[tasks."test:nx:lint:all"]
description = "Test lint all Nx projects"
run = "cd {{vars.PROJECT_NAME}} && nx run-many --target=lint --all"

[tasks."test:nx:test:all"]
description = "Test all Nx projects"
run = "cd {{vars.PROJECT_NAME}} && nx run-many --target=test --all"

[tasks."nx:graph"]
description = "Show Nx project dependency graph"
run = "cd {{vars.PROJECT_NAME}} && nx graph"

[tasks."nx:affected:build"]
description = "Build affected projects"
run = "cd {{vars.PROJECT_NAME}} && nx affected --target=build"

[tasks."nx:affected:test"]
description = "Test affected projects"
run = "cd {{vars.PROJECT_NAME}} && nx affected --target=test"

[tasks."nx:affected:lint"]
description = "Lint affected projects"
run = "cd {{vars.PROJECT_NAME}} && nx affected --target=lint"

# ============================================================================
# DEVELOPMENT WORKFLOW TASKS
# ============================================================================

[tasks."dev"]
description = "Start full development environment"
run = "mise run docker:up && cd {{vars.PROJECT_NAME}} && echo '‚úì Development environment started'"

[tasks."dev:frontend"]
description = "Start frontend development server"
run = "cd {{vars.PROJECT_NAME}} && nx dev employee-portal"

[tasks."dev:backend"]
description = "Start backend development server"
run = "cd {{vars.PROJECT_NAME}} && nx serve api-gateway"

[tasks."dev:stop"]
description = "Stop development environment"
run = "mise run docker:down"

# ============================================================================
# COMPREHENSIVE TESTING TASKS
# ============================================================================

[tasks."test:all"]
description = "Run ALL tests (Docker, K8s, Application)"
run = "bash scripts/ci-test.sh"

[tasks."test:quick"]
description = "Quick validation tests"
run = "mise run docker:validate && mise run k8s:validate && mise run test:nx:install && echo 'Quick tests passed'"

[tasks."ci:test"]
description = "CI/CD test pipeline"
run = "bash scripts/ci-test.sh"

# ============================================================================
# UTILITY TASKS
# ============================================================================

[tasks."clean:all"]
descripti
mise run docker:clean
cd $PROJECT_NAME:clean
cd {{vars.PROJECT_NAME}} && rm -rf node_modules dist .nx
echo '‚úì Cleaned all build artifacts'
"""

[tasks."setup"]
description = "Setup development environment for new users"
run = "bash scripts/setup-dev.sh"

[tasks."help"]
description = "Show available tasks"
run = "mise tasks"

[tasks."urls"]
description = "Show all service URLs"
run = """echo '============================================'
echo 'NEXO CRM Service URLs'
echo '============================================'
echo 'Frontend:    http://localhost:3000'
echo 'Backend API: http://localhost:3001'
echo 'Keycloak:    http://localhost:8080'
echo 'Prometheus:  http://localhost:9090'
echo 'Grafana:     http://localhost:3002'
echo ''
echo 'Database Admin Tools:'
echo 'pgAdmin:     http://localhost:5050'
echo 'RedisInsight: http://localhost:5540'
echo ''
echo 'Database Connections:'
echo 'PostgreSQL:  localhost:5432'
echo 'Redis:       localhost:6379'
echo '============================================'
"""

# ============================================================================
# DATABASE TASKS
# ============================================================================

[tasks."db:shell"]
description = "Connect to PostgreSQL shell"
run = "docker exec -it nexo-postgres psql -U nexo_admin -d nexo_crm"

[tasks."db:backup"]
description = "Create PostgreSQL backup"
run = "mkdir -p backups && docker exec nexo-postgres pg_dump -U nexo_admin nexo_crm > backups/nexo_crm_$(date +%Y%m%d_%H%M%S).sql && echo '‚úÖ Backup created'"

[tasks."db:restore"]
description = "Restore from latest backup"
run = "cat $(ls -t backups/*.sql | head -1) | docker exec -i nexo-postgres psql -U nexo_admin -d nexo_crm && echo '‚úÖ Database restored'"

[tasks."db:seed"]
description = "Seed database with sample data"
run = "docker exec nexo-postgres psql -U nexo_admin -d nexo_crm -f /docker-entrypoint-initdb.d/init.sql"

# ============================================================================
# HEALTH & MONITORING
# ============================================================================

[tasks."health-docker"]
description = "Check Docker services health status"
run = "docker compose -f docker-compose.full.yml ps && echo '\\nTesting endpoints...' && curl -s http://localhost:3000/health > /dev/null && echo '‚úÖ Frontend: OK' || echo '‚ùå Frontend: DOWN'"

[tasks."stats"]
description = "Show Docker resource usage"
run = "docker stats --no-stream --format 'table {{.Container}}\\t{{.CPUPerc}}\\t{{.MemUsage}}\\t{{.MemPerc}}'"

[tasks."logs:all"]
description = "Show all service logs"
run = "docker compose -f docker-compose.full.yml logs -f --tail=100"

[tasks."db:backup:rotate"]
description = "Apply backup rotation policies"
run = "bash scripts/backup-rotation.sh rotate"

[tasks."db:backup:stats"]
description = "Show backup statistics"
run = "bash scripts/backup-rotation.sh stats"

[tasks."redis:shell"]
description = "Connect to Redis CLI"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} exec redis redis-cli"

[tasks."redis:flush"]
description = "Flush Redis cache (WARNING: deletes all data)"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} exec redis redis-cli FLUSHALL && echo '‚ö†Ô∏è  Redis cache flushed'"

# ============================================================================
# MONITORING TASKS
# ============================================================================

[tasks."logs:frontend"]
description = "View frontend logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f frontend"

[tasks."logs:postgres"]
description = "View PostgreSQL logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f postgres"

[tasks."logs:redis"]
description = "View Redis logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f redis"

[tasks."logs:keycloak"]
description = "View Keycloak logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f keycloak"

[tasks."logs:prometheus"]
description = "View Prometheus logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f prometheus"

[tasks."logs:grafana"]
description = "View Grafana logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f grafana"

[tasks."logs:backend"]
description = "View backend API logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f backend"

[tasks."logs:pgadmin"]
description = "View pgAdmin logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f pgadmin"

[tasks."logs:redisinsight"]
description = "View RedisInsight logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f redisinsight"

[tasks."logs:otel"]
description = "View OpenTelemetry Collector logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f otel-collector"

[tasks."logs:jaeger"]
description = "View Jaeger logs"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} logs -f jaeger"

[tasks."test:monitoring"]
description = "Validate monitoring stack configuration and health"
run = "bash scripts/test-monitoring.sh"

[tasks."monitoring:start"]
description = "Start monitoring services only"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} up -d prometheus grafana otel-collector jaeger"

[tasks."monitoring:stop"]
description = "Stop monitoring services"
run = "docker compose -f {{vars.DOCKER_COMPOSE_FILE}} stop prometheus grafana otel-collector jaeger"

[tasks."monitoring:restart"]
description = "Restart monitoring services"
run = "mise run monitoring:stop && mise run monitoring:start"
