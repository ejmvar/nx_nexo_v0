# ============================================================================
# AlertManager Configuration for NEXO CRM
# ============================================================================
# Manages alert routing, grouping, silencing, and notifications
# Reference: https://prometheus.io/docs/alerting/latest/configuration/
# ============================================================================

global:
  # How long to wait before sending notification about new group of alerts
  resolve_timeout: 5m
  
  # Slack webhook URLs (configured via environment variables)
  # Create webhooks at: https://api.slack.com/messaging/webhooks
  # Set in docker/.env file or export as environment variables
  
  # Email SMTP configuration (configured via environment variables)
  # Supported providers: Gmail, SendGrid, Mailgun, AWS SES, custom SMTP
  # Set in docker/.env file or export as environment variables

# ============================================================================
# Templates (for customizing alert messages)
# ============================================================================
# templates:
#   - '/etc/alertmanager/templates/*.tmpl'

# ============================================================================
# Route Configuration (how to route alerts to receivers)
# ============================================================================
route:
  # Default receiver for all alerts
  receiver: 'default-receiver'
  
  # Group alerts by these labels
  group_by: ['alertname', 'service', 'severity']
  
  # Wait time before sending first notification for new group
  group_wait: 30s
  
  # Wait time before sending notification about new alerts in existing group
  group_interval: 5m
  
  # Wait time before re-sending notification if alert is still firing
  repeat_interval: 4h
  
  # Child routes (more specific routing rules)
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 1h
      continue: false
    
    # Warning alerts - less urgent
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 12h
      continue: false
    
    # Infrastructure alerts (database, cache, queue)
    - match:
        component: database
      receiver: 'infrastructure-alerts'
      group_wait: 30s
      repeat_interval: 2h
    
    - match:
        component: cache
      receiver: 'infrastructure-alerts'
    
    - match:
        component: message-queue
      receiver: 'infrastructure-alerts'

# ============================================================================
# Inhibit Rules (suppress certain alerts when other alerts are firing)
# ============================================================================
inhibit_rules:
  # If service is down, don't alert on high error rate (obvious consequence)
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'HighErrorRate'
    equal: ['service']
  
  # If disk is full, don't alert on database slow (likely cause)
  - source_match:
      alertname: 'DiskSpaceLow'
    target_match:
      alertname: 'DatabaseSlow'
    equal: ['instance']

# ============================================================================
# Receivers (notification destinations)
# ============================================================================
receivers:
  # Default receiver (logs only, no external notification)
  - name: 'default-receiver'
    # No webhook/slack/email configured - alerts will be visible in AlertManager UI only
  
  # Critical alerts receiver
  - name: 'critical-alerts'
    # Slack integration for critical alerts
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL_CRITICAL}'
        channel: '#alerts-critical'
        username: 'NEXO AlertManager'
        icon_emoji: ':rotating_light:'
        title: 'üö® CRITICAL ALERT: {{ .CommonLabels.alertname }}'
        title_link: 'http://localhost:9090/alerts'
        text: |-
          *Alert:* {{ .CommonLabels.alertname }}
          *Service:* {{ .CommonLabels.service }}
          *Severity:* {{ .CommonLabels.severity }}
          *Status:* {{ .Status | toUpper }}
          
          *Description:*
          {{ range .Alerts }}{{ .Annotations.description }}
          {{ end }}
          
          *Runbook:* {{ .CommonAnnotations.runbook }}
          *Dashboard:* {{ .CommonAnnotations.dashboard }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
    
    # Email notification for critical alerts
    email_configs:
      - to: '${ALERT_EMAIL_TO_CRITICAL}'
        from: '${ALERT_EMAIL_FROM}'
        smarthost: '${SMTP_HOST}:${SMTP_PORT}'
        auth_username: '${SMTP_USER}'
        auth_password: '${SMTP_PASSWORD}'
        require_tls: true
        subject: 'üö® CRITICAL: {{ .CommonLabels.alertname }} - {{ .CommonLabels.service }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .alert-box { background: #f8d7da; border: 2px solid #dc3545; border-radius: 5px; padding: 20px; margin: 20px 0; }
              .alert-header { color: #dc3545; font-size: 24px; font-weight: bold; margin-bottom: 15px; }
              .alert-info { margin: 10px 0; }
              .label { font-weight: bold; color: #555; }
              .value { color: #000; }
              .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
              a { color: #007bff; text-decoration: none; }
            </style>
          </head>
          <body>
            <div class="alert-box">
              <div class="alert-header">üö® CRITICAL ALERT</div>
              <div class="alert-info"><span class="label">Alert:</span> <span class="value">{{ .CommonLabels.alertname }}</span></div>
              <div class="alert-info"><span class="label">Service:</span> <span class="value">{{ .CommonLabels.service }}</span></div>
              <div class="alert-info"><span class="label">Severity:</span> <span class="value">{{ .CommonLabels.severity }}</span></div>
              <div class="alert-info"><span class="label">Status:</span> <span class="value">{{ .Status | toUpper }}</span></div>
              <div class="alert-info"><span class="label">Time:</span> <span class="value">{{ .CommonAnnotations.timestamp }}</span></div>
            </div>
            
            <h3>Description</h3>
            <p>{{ range .Alerts }}{{ .Annotations.description }}<br>{{ end }}</p>
            
            <h3>Actions</h3>
            <p>
              <a href="{{ .CommonAnnotations.runbook }}">üìñ View Runbook</a> |
              <a href="{{ .CommonAnnotations.dashboard }}">üìä Open Dashboard</a> |
              <a href="http://localhost:9093">üîî AlertManager</a>
            </p>
            
            <div class="footer">
              <p>This is an automated alert from NEXO CRM Monitoring System.</p>
              <p>To silence this alert, visit <a href="http://localhost:9093">AlertManager</a>.</p>
            </div>
          </body>
          </html>
        send_resolved: true
  
  # Warning alerts receiver
  - name: 'warning-alerts'
    # Slack integration for warning alerts
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL_WARNINGS}'
        channel: '#alerts-warnings'
        username: 'NEXO AlertManager'
        icon_emoji: ':warning:'
        title: '‚ö†Ô∏è  WARNING: {{ .CommonLabels.alertname }}'
        title_link: 'http://localhost:9090/alerts'
        text: |-
          *Alert:* {{ .CommonLabels.alertname }}
          *Service:* {{ .CommonLabels.service }}
          *Status:* {{ .Status | toUpper }}
          
          *Description:*
          {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          *Runbook:* {{ .CommonAnnotations.runbook }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
    
    # Email notification for warning alerts
    email_configs:
      - to: '${ALERT_EMAIL_TO_WARNINGS}'
        from: '${ALERT_EMAIL_FROM}'
        smarthost: '${SMTP_HOST}:${SMTP_PORT}'
        auth_username: '${SMTP_USER}'
        auth_password: '${SMTP_PASSWORD}'
        require_tls: true
        subject: '‚ö†Ô∏è  WARNING: {{ .CommonLabels.alertname }} - {{ .CommonLabels.service }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .alert-box { background: #fff3cd; border: 2px solid #ffc107; border-radius: 5px; padding: 20px; margin: 20px 0; }
              .alert-header { color: #856404; font-size: 24px; font-weight: bold; margin-bottom: 15px; }
              .alert-info { margin: 10px 0; }
              .label { font-weight: bold; color: #555; }
              .value { color: #000; }
              a { color: #007bff; text-decoration: none; }
            </style>
          </head>
          <body>
            <div class="alert-box">
              <div class="alert-header">‚ö†Ô∏è  WARNING ALERT</div>
              <div class="alert-info"><span class="label">Alert:</span> <span class="value">{{ .CommonLabels.alertname }}</span></div>
              <div class="alert-info"><span class="label">Service:</span> <span class="value">{{ .CommonLabels.service }}</span></div>
              <div class="alert-info"><span class="label">Status:</span> <span class="value">{{ .Status | toUpper }}</span></div>
            </div>
            <h3>Description</h3>
            <p>{{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
            <p><a href="{{ .CommonAnnotations.runbook }}">View Runbook</a></p>
          </body>
          </html>
        send_resolved: true
  
  # Infrastructure alerts receiver
  - name: 'infrastructure-alerts'
    # Slack integration for infrastructure alerts
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL_INFRASTRUCTURE}'
        channel: '#alerts-infrastructure'
        username: 'NEXO AlertManager'
        icon_emoji: ':wrench:'
        title: 'üîß INFRASTRUCTURE: {{ .CommonLabels.alertname }}'
        title_link: 'http://localhost:9090/alerts'
        text: |-
          *Component:* {{ .CommonLabels.component }}
          *Status:* {{ .Status | toUpper }}
          
          {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
    
    # Email notification for infrastructure alerts
    email_configs:
      - to: '${ALERT_EMAIL_TO_INFRASTRUCTURE}'
        from: '${ALERT_EMAIL_FROM}'
        smarthost: '${SMTP_HOST}:${SMTP_PORT}'
        auth_username: '${SMTP_USER}'
        auth_password: '${SMTP_PASSWORD}'
        require_tls: true
        subject: 'üîß INFRASTRUCTURE: {{ .CommonLabels.alertname }}'
        html: '<h3>Infrastructure Alert</h3><p>{{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>'
        send_resolved: true

# ============================================================================
# Configuration Notes
# ============================================================================
# 1. Alert Lifecycle:
#    Firing ‚Üí AlertManager ‚Üí Routing ‚Üí Grouping ‚Üí Notification ‚Üí Resolved
#
# 2. Grouping:
#    Combines multiple similar alerts into single notification
#    Example: 5 pods of same service down = 1 notification (not 5)
#
# 3. Inhibition:
#    Prevents duplicate/obvious alerts
#    Example: If service is down, don't alert on "no metrics" (duh!)
#
# 4. Silencing:
#    Temporarily mute alerts via UI (during maintenance)
#    CLI: amtool silence add alertname="HighCPU" --duration=1h
#
# 5. Testing Alerts:
#    Send test alert to AlertManager:
#    curl -X POST http://localhost:9093/api/v1/alerts -d '[{
#      "labels": {"alertname":"TestAlert","severity":"warning"},
#      "annotations": {"description":"This is a test alert"}
#    }]'
#
# 6. Notification Integrations:
#    - Slack: webhook URL from Slack app
#    - Email: SMTP settings (Gmail, SendGrid, Mailgun)
#    - PagerDuty: integration key
#    - Webhook: custom HTTP endpoint
#    - OpsGenie, VictorOps, WeChat, Telegram, etc.
#
# 7. Best Practices:
#    - Use severity labels: critical, warning, info
#    - Group related alerts together
#    - Set appropriate repeat_interval (don't spam!)
#    - Use inhibit rules to reduce noise
#    - Document runbook URLs in alert annotations
#    - Test notification channels before production
#
# 8. Enable Notifications (when ready):
#    - Set environment variables in .env file
#    - Uncomment receiver configs above
#    - Restart AlertManager: docker compose restart alertmanager
#    - Send test alert to verify
#
# ============================================================================
