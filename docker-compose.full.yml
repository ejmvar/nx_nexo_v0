# NEXO Full Stack - Docker Compose
# ==================================
# Complete multi-container orchestration for development
# Optimized for Raspberry Pi compatibility

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: nexo-postgres
    environment:
      POSTGRES_DB: nexo_crm
      POSTGRES_USER: nexo_admin
      POSTGRES_PASSWORD: nexo_dev_password_2026
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      POSTGRES_MAX_CONNECTIONS: "50"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - nexo-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexo_admin -d nexo_crm"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=256MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "work_mem=4MB"

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: nexo-redis
    ports:
      - "6379:6379"
    networks:
      - nexo-network
    volumes:
      - redis_data:/data
    command:
      - redis-server
      - --appendonly yes
      - --maxmemory 128mb
      - --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # Auth Service (Port 3001)
  auth-service:
    build:
      context: ./nexo-prj
      dockerfile: apps/auth-service/Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
    container_name: nexo-auth-service
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=nexo_crm
      - DB_USER=nexo_admin
      - DB_PASSWORD=nexo_dev_password_2026
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=nexo_jwt_secret_key_2026_change_in_production
      - NODE_OPTIONS=--max-old-space-size=256
    networks:
      - nexo-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    restart: unless-stopped

  # API Gateway (Port 3002)
  api-gateway:
    build:
      context: ./nexo-prj
      dockerfile: apps/api-gateway/Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
    container_name: nexo-api-gateway
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - AUTH_SERVICE_URL=http://auth-service:3001
      - CRM_SERVICE_URL=http://crm-service:3003
      - NODE_OPTIONS=--max-old-space-size=256
    networks:
      - nexo-network
    depends_on:
      - auth-service
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    restart: unless-stopped

  # CRM Service (Port 3003)
  crm-service:
    build:
      context: ./nexo-prj
      dockerfile: apps/crm-service/Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
    container_name: nexo-crm-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=nexo_crm
      - DB_USER=nexo_admin
      - DB_PASSWORD=nexo_dev_password_2026
      - NODE_OPTIONS=--max-old-space-size=256
    networks:
      - nexo-network
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    restart: unless-stopped

  # Frontend (Port 3000)
  frontend:
    build:
      context: ./nexo-prj
      dockerfile: apps/nexo-prj/Dockerfile.prod
      platforms:
        - linux/amd64
        - linux/arm64
        - linux/arm/v7
    container_name: nexo-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost:3002
      - NEXT_PUBLIC_AUTH_URL=http://localhost:3001
      - NODE_OPTIONS=--max-old-space-size=384
    networks:
      - nexo-network
    depends_on:
      - api-gateway
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 384M
        reservations:
          cpus: '0.25'
          memory: 192M
    restart: unless-stopped

networks:
  nexo-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
